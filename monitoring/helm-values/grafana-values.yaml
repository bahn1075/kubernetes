#############################################################################
 ####  helm uninstall grafana -n monitoring 
 ####  helm install grafana grafana/grafana -n monitoring \
 ####  -f /app/mykubernetes/monitoring/helm-values/grafana-values.yaml
#############################################################################
# Grafana values for OCI deployment
nameOverride: "grafana"
fullnameOverride: "grafana"

# 이미지 설정
image:
  repository: grafana/grafana
  tag: latest
  pullPolicy: IfNotPresent

# 복제본 설정
replicas: 1

# Pod Security Context
podSecurityContext:
  fsGroup: 472
  runAsNonRoot: true
  runAsUser: 472

# 리소스 제한
resources:
  requests:
    cpu: 20m
    memory: 128Mi

# 서비스 설정
service:
  type: ClusterIP
  port: 80
  targetPort: 3000

# Ingress 설정
ingress:
  enabled: true
  ingressClassName: nginx
  hosts:
    - grafana.64bit.kr
  path: /
  pathType: Prefix
  tls: []

# 환경 변수 설정
env:
  GF_INSTALL_PLUGINS: "grafana-piechart-panel,grafana-worldmap-panel"
  GF_PATHS_DATA: "/var/lib/grafana"
  GF_PATHS_LOGS: "/var/log/grafana"
  GF_PATHS_PLUGINS: "/var/lib/grafana/plugins"
  GF_PATHS_PROVISIONING: "/etc/grafana/provisioning"

# Admin 사용자 시크릿 (기존 시크릿 사용)
admin:
  existingSecret: grafana-admin
  userKey: admin-user
  passwordKey: admin-password

# Grafana 설정 (grafana.ini)
grafana.ini:
  server:
    root_url: http://grafana.64bit.kr
  smtp:
    enabled: true
    host: smtp.gmail.com:587
    user: your-email@gmail.com
    password: your-app-password
    skip_verify: false
    from_address: your-email@gmail.com
    from_name: Grafana Alerting
    startTLS_policy: MandatoryStartTLS

# 데이터소스 프로비저닝
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus-operated.monitoring.svc.cluster.local:9090
        access: proxy
        isDefault: true
      - name: Loki
        type: loki
        url: http://loki.monitoring.svc.cluster.local:3100
        access: proxy
      - name: Tempo
        type: tempo
        url: http://tempo.monitoring.svc.cluster.local:3200
        access: proxy

# values.yaml 내에 추가 (차트에 따라 key가 다를 수 있음; grafana 공식 차트는 extraInitContainers 지원)
initChownData:
  enabled: true

# extraInitContainers:
#   - name: ensure-dashboards-dir
#     image: busybox
#     command: ["sh", "-c"]
#     args:
#       - |
#         mkdir -p /var/lib/grafana/dashboards/default && \
#         chown -R 472:472 /var/lib/grafana/dashboards && \
#         ls -la /var/lib/grafana/dashboards/default
#     securityContext:
#       runAsUser: 472
#       runAsGroup: 472
#     volumeMounts:
#       - name: storage
#         mountPath: /var/lib/grafana

# ✅ 여기만 바꿉니다: 기존 PVC 사용 + subPath=grafana
persistence:
  enabled: true
  # 기존 PVC를 사용해서 동적 생성 방지
  existingClaim: grafana-pvc
  # /var/lib/grafana에 FSS 루트(/oke-fss) 대신 하위 디렉토리(/oke-fss/grafana) 마운트
  subPath: grafana
  # init container 비활성화 (subPath 사용 시 권한 문제 방지)
  initChownData: false
  # 아래 값들은 existingClaim 사용 시 실제로는 무시되지만, 남겨도 무방
  accessModes:
    - ReadWriteMany
  size: 5Gi

# 대시보드 ConfigMap 마운트
extraVolumes:
  - name: dashboards
    configMap:
      name: grafana-dashboards

extraVolumeMounts:
  - name: dashboards
    mountPath: /var/lib/grafana/dashboards/default


# Liveness Probe 설정
livenessProbe:
  httpGet:
    path: /api/health
    port: 3000
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 30
  failureThreshold: 10

# Readiness Probe 설정
readinessProbe:
  httpGet:
    path: /api/health
    port: 3000
  initialDelaySeconds: 30
  periodSeconds: 10

# 레이블 설정
labels:
  app: grafana
  environment: oci
