- Deploy Strimzi using installation files

kubectl create namespace kafka
kubectl create -f 'https://strimzi.io/install/latest?namespace=kafka' -n kafka

- Create an Apache Kafka cluster

# Apply the `Kafka` Cluster CR file
kubectl apply -f /app/mykubernetes/kafka/kafka-single-node.yaml -n kafka 

# Producer (ì¼íšŒì„±)
kubectl run kafka-producer -n kafka \
  --image=quay.io/strimzi/kafka:0.49.1-kafka-4.1.1 \
  --rm -it --restart=Never \
  -- bin/kafka-console-producer.sh \
  --bootstrap-server my-cluster-kafka-plain-bootstrap:9092 \
  --topic my-topic

# Consumer (ì¼íšŒì„±, ë‹¤ë¥¸ í„°ë¯¸ë„ ìµœì´ˆ WARN ë©”ì„¸ì§€ ë°œìƒí•  ìˆ˜ ìˆìŒ)
kubectl run kafka-consumer -n kafka \
  --image=quay.io/strimzi/kafka:0.49.1-kafka-4.1.1 \
  --rm -it --restart=Never \
  -- bin/kafka-console-consumer.sh \
  --bootstrap-server my-cluster-kafka-plain-bootstrap:9092 \
  --topic my-topic \
  --from-beginning

5. kafka ui ì‹¤í–‰
5-1 ì¼ë°˜ helm install : helm install kafka-ui /app/mykubernetes/kafka/kafka-ui -n kafka
5-2 ingress í•¨ê»˜
  helm install kafka-ui /app/mykubernetes/kafka/kafka-ui -n kafka \
    --set ingress.enabled=true \
    --set ingress.ingressClassName=nginx \
    --set ingress.host=kafka.64bit.kr \
    --set ingress.path=/ \
    --set ingress.pathType=Prefix \
    --set-string ingress.annotations."nginx\.ingress\.kubernetes\.io/backend-protocol"=HTTP \
    --set ingress.tls.enabled=false

5-3 ingress í¬í•¨ helm install ì‹¤íŒ¨í•  ê²½ìš° ì•„ë˜ yaml íŒŒì¼ ìƒì„±í›„ ì ìš©
apiVersion: networking.k8s.io/v1
 kind: Ingress
 metadata:
   name: kafka-ui-ingress
   namespace: kafka
   annotations:
     nginx.ingress.kubernetes.io/backend-protocol: HTTP
 spec:
   ingressClassName: nginx
   rules:
   - host: kafka.64bit.kr
     http:
       paths:
       - path: /
         pathType: Prefix
         backend:
           service:
             name: kafka-ui
             port:
               number: 80





6. grafanaì—ì„œ kafka ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ kafka export helm ì„¤ì¹˜

# Helm repo ì¶”ê°€
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Kafka Exporter ì„¤ì¹˜
helm install kafka-exporter prometheus-community/prometheus-kafka-exporter \
  -n monitoring \
  --set image.registry=docker.io \
  --set image.repository=danielqsj/kafka-exporter \
  --set image.tag=v1.9.0 \
  --set 'kafkaServer[0]=my-cluster-kafka-plain-bootstrap.kafka.svc.cluster.local:9092' \
  --set serviceMonitor.enabled=true \
  --set serviceMonitor.namespace=monitoring \
  --set 'serviceMonitor.additionalLabels.release=kube-prometheus-stack'

# ì‚­ì œ
helm uninstall kafka-exporter -n monitoring



6. wslì—ì„œëŠ” kafbat-uiì— firefoxë¥¼ ubuntu ë‚´ë¶€ì— ì„¤ì¹˜í•˜ê³ 
   192ë¡œì»¬ ipë¡œ ì ‘ê·¼í•œë‹¤

##################ì°¸ê³ 

 ğŸ” ê¶Œí•œ ì—ëŸ¬ ë°œìƒ ì›ì¸

  ë‹¹ì‹ ì´ ì–¸ê¸‰í•œ ëŒ€ë¡œ /oke-fss/kafkaëŠ” 472:472 ì†Œìœ ê¶Œìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ, í˜„ì¬ëŠ” ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ê°€ **1001:0 (kafka:root)**ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.

  ì´ëŠ” Kubernetesì˜ fsGroup ê¸°ëŠ¥ ë•ë¶„ì…ë‹ˆë‹¤:

  # kafka-single-node.yaml:80
  template:
    pod:
      securityContext:
        fsGroup: 1001  # â† ì´ ì„¤ì •ì´ í•µì‹¬!

  fsGroupì˜ ì—­í• :
  - Podê°€ ë³¼ë¥¨ì„ ë§ˆìš´íŠ¸í•  ë•Œ, Kubernetesê°€ ìë™ìœ¼ë¡œ GIDë¥¼ 1001ë¡œ ë³€ê²½
  - ëª¨ë“  ìƒˆë¡œ ìƒì„±ë˜ëŠ” íŒŒì¼ì€ GID 1001ë¡œ ì„¤ì •
  - ê¸°ì¡´ íŒŒì¼/ë””ë ‰í† ë¦¬ë„ fsGroup GIDë¡œ ì¬ê·€ì ìœ¼ë¡œ ë³€ê²½ (ì˜µì…˜ì— ë”°ë¼)

  âŒ ë³„ë„ PVC ë°©ì‹ì—ì„œ ì‹¤íŒ¨í•œ ì´ìœ 

  1. ê¶Œí•œ ì¶©ëŒ:
    - íŒŒì¼ì‹œìŠ¤í…œ: 472:472 ì†Œìœ ê¶Œ
    - Kafka í”„ë¡œì„¸ìŠ¤: UID 1001 í•„ìš”
    - fsGroup ì—†ì´ ë§ˆìš´íŠ¸í•˜ë©´ â†’ Permission Denied
  2. Strimzi ì¸ì‹ ë¬¸ì œ:
    - StrimziëŠ” ìì‹ ì´ ìƒì„±í•˜ì§€ ì•Šì€ PVCë¥¼ ì‚¬ìš©í•  ë•Œ ë” ì—„ê²©í•˜ê²Œ ê²€ì¦
    - í•„ìš”í•œ ë ˆì´ë¸”/ì–´ë…¸í…Œì´ì…˜ì´ ì—†ìœ¼ë©´ ê±°ë¶€í•˜ê±°ë‚˜ ì œëŒ€ë¡œ ê´€ë¦¬í•˜ì§€ ëª»í•¨
  3. íƒ€ì´ë° ì´ìŠˆ:
    - Strimziê°€ PVCë¥¼ ë¨¼ì € ìƒì„±í•˜ë ¤ê³  ì‹œë„ â†’ ì´ë¯¸ ì¡´ì¬í•¨ â†’ ì¶©ëŒ
    - ë˜ëŠ” PVCë¥¼ ì°¾ì§€ ëª»í•¨ (ì´ë¦„ ë¶ˆì¼ì¹˜, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¬¸ì œ ë“±)

  âœ… í˜„ì¬ ë°©ì‹ì´ ì„±ê³µí•œ ì´ìœ 

  1. ì •í™•í•œ PVC ì´ë¦„: data-{id}-{cluster}-{pool}-{replica} ê·œì¹™ ì¤€ìˆ˜
  2. Strimziê°€ PVC ë°œê²¬: ì´ë¯¸ ì¡´ì¬ â†’ ë ˆì´ë¸” ì¶”ê°€ â†’ ê´€ë¦¬ ì‹œì‘
  3. fsGroup ìë™ ì ìš©: 472:472 â†’ 1001:0ìœ¼ë¡œ ê¶Œí•œ ë³€ê²½
  4. ë‹¨ì¼ íŒŒì¼ ì ìš©: ìˆœì„œ ë³´ì¥ (PV â†’ PVC â†’ KafkaNodePool â†’ Kafka)

  ğŸ’¡ ë³„ë„ íŒŒì¼ë¡œ í•˜ë ¤ë©´?

  ë§Œì•½ ë³„ë„ íŒŒì¼ë¡œ ê´€ë¦¬í•˜ê³  ì‹¶ë‹¤ë©´:

  # 1. PV/PVC ë¨¼ì € ìƒì„± (ì •í™•í•œ ì´ë¦„ ì‚¬ìš©!)
  kubectl apply -f kafka-pv.yaml
  kubectl apply -f kafka-pvc.yaml

  # 2. PVCì— Strimzi ë ˆì´ë¸” ìˆ˜ë™ ì¶”ê°€
  kubectl label pvc data-0-my-cluster-dual-role-0 \
    strimzi.io/cluster=my-cluster \
    app.kubernetes.io/managed-by=strimzi-cluster-operator

  # 3. Kafka ë¦¬ì†ŒìŠ¤ ìƒì„± (fsGroup í•„ìˆ˜!)
  kubectl apply -f kafka-single-node.yaml

  í•˜ì§€ë§Œ í˜„ì¬ ë‹¨ì¼ íŒŒì¼ ë°©ì‹ì´ ë” ì•ˆì „í•˜ê³  ê´€ë¦¬í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤! ğŸ¯